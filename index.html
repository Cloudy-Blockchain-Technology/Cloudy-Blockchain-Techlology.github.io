<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключаем SDK Adsonar с вашим APP_ID -->
    <script src="https://static.sonartech.io/lib/1.0.0/sonar.js?appId=app_d2d8f4fc"></script>
</head>
<body>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const startApp = urlParams.get('startapp');
        const userId = startApp.split('_')[2];

        // Функция для отправки результата просмотра рекламы вашему боту
        async function notifyAdComplete() {
            try {
                const response = await fetch('https://your-api.com/ad-completed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        completed: true
                    })
                });

                if (response.ok) {
                    tg.close();
                }
            } catch (error) {
                console.error('Error:', error);
                tg.showAlert("Произошла ошибка. Попробуйте еще раз.");
            }
        }

        // Показываем рекламу сразу при открытии
        window.Sonar.show({
            adUnit: 'app_d2d8f4fc',
            loader: true,
            onStart: () => {
                console.log('Реклама начала загружаться');
            },
            onShow: () => {
                console.log('Реклама показана');
            },
            onError: () => {
                tg.showAlert("Ошибка при загрузке рекламы. Попробуйте позже.");
                tg.close();
            },
            onClose: () => {
                // Когда пользователь закрыл рекламу, отправляем уведомление
                notifyAdComplete();
            }
        }).then((result) => {
            if (result.status === 'error') {
                console.error('Ошибка показа рекламы:', result.message);
                tg.showAlert("Не удалось показать рекламу. Попробуйте позже.");
                tg.close();
            }
        }).catch((err) => {
            console.error('Unexpected error:', err);
            tg.showAlert("Произошла непредвиденная ошибка.");
            tg.close();
        });
    </script>
</body>
</html>